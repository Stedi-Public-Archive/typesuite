"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.sendSoapRequest = exports.deserializeSoapResponse = exports.serializeSoapRequest = void 0;
const crypto_1 = require("crypto");
const axios_1 = __importDefault(require("axios"));
const http_1 = __importDefault(require("axios/lib/adapters/http"));
const jsonix_1 = require("jsonix");
const platform_core_1 = require("./netsuite_webservices/2019_2/platform_core");
const mappings_1 = __importDefault(require("./netsuite_webservices/2019_2/mappings"));
const mappings_2 = __importDefault(require("./xmlsoap/mappings"));
const envelope_1 = require("./xmlsoap/envelope");
const com_netsuite_webservices_platform_messages_2019_2_1 = require("./netsuite_webservices/2019_2/__mappings/com_netsuite_webservices_platform_messages_2019_2");
const platform_messages_1 = require("./netsuite_webservices/2019_2/platform_messages");
const ALL_MAPPINGS = [...mappings_2.default, ...mappings_1.default];
const JSONIX_CONTEXT_OPTIONS = {
    namespacePrefixes: {
        "http://www.w3.org/2001/XMLSchema-instance": "xsi",
        "http://schemas.xmlsoap.org/soap/envelope/": "soap",
        "urn:common_2019_2.platform.webservices.netsuite.com": "platform_common",
        "urn:core_2019_2.platform.webservices.netsuite.com": "platform_core",
        "urn:messages_2019_2.platform.webservices.netsuite.com": "platform_messages",
    },
};
function elementKeyFor(object) {
    var _a;
    const elementName = (_a = com_netsuite_webservices_platform_messages_2019_2_1.com_netsuite_webservices_platform_messages_2019_2.elementInfos.find((elementInfo) => {
        const typeInfo = elementInfo.typeInfo.split(".").slice(-1)[0];
        return typeInfo === object.constructor.name;
    })) === null || _a === void 0 ? void 0 : _a.elementName;
    return `platform_messages:${
    // eslint-disable-next-line @typescript-eslint/restrict-template-expressions
    elementName !== null && elementName !== void 0 ? elementName : "<<" + object.constructor.name + ">>"}`;
}
function serializeSoapRequest(passport, body, preferences) {
    const passportElement = { name: elementKeyFor(passport), value: passport };
    const headerElements = [passportElement];
    if (preferences) {
        const prefs = new platform_messages_1.Preferences(preferences);
        headerElements.push({
            name: elementKeyFor(prefs),
            value: prefs,
        });
    }
    const bodyElement = { name: elementKeyFor(body), value: body };
    const envelope = new envelope_1.Envelope({
        header: new envelope_1.Header({ any: headerElements }),
        body: new envelope_1.Body({ any: [bodyElement] }),
    });
    const data = { "soap:Envelope": envelope };
    const context = new jsonix_1.Jsonix.Context(ALL_MAPPINGS, JSONIX_CONTEXT_OPTIONS);
    const xmlString = context.createMarshaller().marshalString(data);
    return '<?xml version="1.0" encoding="utf-8"?>' + xmlString;
}
exports.serializeSoapRequest = serializeSoapRequest;
function deserializeSoapResponse(xmlContent) {
    const context = new jsonix_1.Jsonix.Context(ALL_MAPPINGS);
    return context.createUnmarshaller().unmarshalString(xmlContent);
}
exports.deserializeSoapResponse = deserializeSoapResponse;
function endpoint(config) {
    const account = config.account.replace("_", "-");
    return `https://${account}.suitetalk.api.netsuite.com/services/NetSuitePort_${config.apiVersion}`;
}
/**
 * Serializes the provided request into XML and sends a SOAP request to the configured
 * endpoint. For successful responses, returns the data extracted the envelope and cast
 * into the type specified by the generic type parameter R.
 *
 * If the SOAP request results in a failed response, returns the SOAP Fault within
 * the envelope as a rejected promise.
 *
 * @param config
 * @param request
 * @param soapAction
 */
async function sendSoapRequest(config, request, soapAction) {
    const authToken = authenticateRequestWithTokenPassport(config);
    const soapXML = serializeSoapRequest(authToken, request, config.preferences);
    try {
        const response = await axios_1.default.post(endpoint(config), soapXML, {
            headers: {
                SOAPAction: soapAction,
                contentType: "text/xml; charset=UTF-8",
            },
            // We are using this library in Node, this works well for Jest and Production.
            adapter: http_1.default,
        });
        const soapEnvelope = deserializeSoapResponse(response.data);
        return soapEnvelope.value.body.any[0].value;
    }
    catch (error) {
        if (error.response) {
            // Non 20x response
            const soapEnvelope = deserializeSoapResponse(error.response.data);
            const fault = soapEnvelope.value.body.any[0].value;
            return Promise.reject(fault);
        }
        else {
            // Network error.
            throw error;
        }
    }
}
exports.sendSoapRequest = sendSoapRequest;
function authenticateRequestWithTokenPassport(config) {
    const nonce = crypto_1.randomBytes(18).toString("hex");
    const timeStamp = Math.round(new Date().getTime() / 1000);
    const baseString = [
        config.account,
        config.token.consumerKey,
        config.token.tokenKey,
        nonce,
        timeStamp,
    ].join("&");
    const base64hash = crypto_1.createHmac("sha256", `${config.token.consumerSecret}&${config.token.tokenSecret}`)
        .update(baseString)
        .digest("base64");
    return new platform_core_1.TokenPassport({
        account: config.account,
        consumerKey: config.token.consumerKey,
        nonce: nonce,
        timestamp: timeStamp,
        token: config.token.tokenKey,
        signature: {
            algorithm: "HMAC_SHA256",
            value: base64hash,
        },
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic29hcC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9zb2FwLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLG1DQUFpRDtBQUNqRCxrREFBMEI7QUFDMUIsbUVBQWtEO0FBQ2xELG1DQUFnQztBQUNoQywrRUFBNEU7QUFDNUUsc0ZBQXNFO0FBQ3RFLGtFQUFpRDtBQUNqRCxpREFBbUU7QUFDbkUsa0tBQTJLO0FBRTNLLHVGQUd5RDtBQUV6RCxNQUFNLFlBQVksR0FBRyxDQUFDLEdBQUcsa0JBQWUsRUFBRSxHQUFHLGtCQUFnQixDQUFDLENBQUM7QUFFL0QsTUFBTSxzQkFBc0IsR0FBRztJQUM3QixpQkFBaUIsRUFBRTtRQUNqQiwyQ0FBMkMsRUFBRSxLQUFLO1FBQ2xELDJDQUEyQyxFQUFFLE1BQU07UUFDbkQscURBQXFELEVBQUUsaUJBQWlCO1FBQ3hFLG1EQUFtRCxFQUFFLGVBQWU7UUFDcEUsdURBQXVELEVBQ3JELG1CQUFtQjtLQUN0QjtDQUNGLENBQUM7QUFVRixTQUFTLGFBQWEsQ0FBQyxNQUF5Qzs7SUFDOUQsTUFBTSxXQUFXLFNBQUcscUdBQVEsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUMsV0FBd0IsRUFBRSxFQUFFO1FBQzFFLE1BQU0sUUFBUSxHQUFHLFdBQVcsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzlELE9BQU8sUUFBUSxLQUFLLE1BQU0sQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDO0lBQzlDLENBQUMsQ0FBQywwQ0FBRSxXQUFXLENBQUM7SUFDaEIsT0FBTyxxQkFBcUI7SUFDMUIsNEVBQTRFO0lBQzVFLFdBQVcsYUFBWCxXQUFXLGNBQVgsV0FBVyxHQUFJLElBQUksR0FBRyxNQUFNLENBQUMsV0FBVyxDQUFDLElBQUksR0FBRyxJQUNsRCxFQUFFLENBQUM7QUFDTCxDQUFD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RSxNQUFNLENBQUMsS0FBSyxDQUFDLFdBQVc7UUFDckMsS0FBSyxFQUFFLEtBQUs7UUFDWixTQUFTLEVBQUUsU0FBUztRQUNwQixLQUFLLEVBQUUsTUFBTSxDQUFDLEtBQUssQ0FBQyxRQUFRO1FBQzVCLFNBQVMsRUFBRTtZQUNULFNBQVMsRUFBRSxhQUFhO1lBQ3hCLEtBQUssRUFBRSxVQUFVO1NBQ2xCO0tBQ0YsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGNyZWF0ZUhtYWMsIHJhbmRvbUJ5dGVzIH0gZnJvbSBcImNyeXB0b1wiO1xuaW1wb3J0IGF4aW9zIGZyb20gXCJheGlvc1wiO1xuaW1wb3J0IGh0dHBBZGFwdGVyIGZyb20gXCJheGlvcy9saWIvYWRhcHRlcnMvaHR0cFwiO1xuaW1wb3J0IHsgSnNvbml4IH0gZnJvbSBcImpzb25peFwiO1xuaW1wb3J0IHsgVG9rZW5QYXNzcG9ydCB9IGZyb20gXCIuL25ldHN1aXRlX3dlYnNlcnZpY2VzLzIwMTlfMi9wbGF0Zm9ybV9jb3JlXCI7XG5pbXBvcnQgTmV0U3VpdGVNYXBwaW5ncyBmcm9tIFwiLi9uZXRzdWl0ZV93ZWJzZXJ2aWNlcy8yMDE5XzIvbWFwcGluZ3NcIjtcbmltcG9ydCBYbWxTb2FwTWFwcGluZ3MgZnJvbSBcIi4veG1sc29hcC9tYXBwaW5nc1wiO1xuaW1wb3J0IHsgQm9keSwgRW52ZWxvcGUsIEZhdWx0LCBIZWFkZXIgfSBmcm9tIFwiLi94bWxzb2FwL2VudmVsb3BlXCI7XG5pbXBvcnQgeyBjb21fbmV0c3VpdGVfd2Vic2VydmljZXNfcGxhdGZvcm1fbWVzc2FnZXNfMjAxOV8yIGFzIHBsYXRmb3JtIH0gZnJvbSBcIi4vbmV0c3VpdGVfd2Vic2VydmljZXMvMjAxOV8yL19fbWFwcGluZ3MvY29tX25ldHN1aXRlX3dlYnNlcnZpY2VzX3BsYXRmb3JtX21lc3NhZ2VzXzIwMTlfMlwiO1xuaW1wb3J0IHsgQ29uZmlndXJhdGlvbiB9IGZyb20gXCIuL3R5cGVzXCI7XG5pbXBvcnQge1xuICBQcmVmZXJlbmNlcyxcbiAgUHJlZmVyZW5jZXNQcm9wcyxcbn0gZnJvbSBcIi4vbmV0c3VpdGVfd2Vic2VydmljZXMvMjAxOV8yL3BsYXRmb3JtX21lc3NhZ2VzXCI7XG5cbmNvbnN0IEFMTF9NQVBQSU5HUyA9IFsuLi5YbWxTb2FwTWFwcGluZ3MsIC4uLk5ldFN1aXRlTWFwcGluZ3NdO1xuXG5jb25zdCBKU09OSVhfQ09OVEVYVF9PUFRJT05TID0ge1xuICBuYW1lc3BhY2VQcmVmaXhlczoge1xuICAgIFwiaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEtaW5zdGFuY2VcIjogXCJ4c2lcIixcbiAgICBcImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3NvYXAvZW52ZWxvcGUvXCI6IFwic29hcFwiLFxuICAgIFwidXJuOmNvbW1vbl8yMDE5XzIucGxhdGZvcm0ud2Vic2VydmljZXMubmV0c3VpdGUuY29tXCI6IFwicGxhdGZvcm1fY29tbW9uXCIsXG4gICAgXCJ1cm46Y29yZV8yMDE5XzIucGxhdGZvcm0ud2Vic2VydmljZXMubmV0c3VpdGUuY29tXCI6IFwicGxhdGZvcm1fY29yZVwiLFxuICAgIFwidXJuOm1lc3NhZ2VzXzIwMTlfMi5wbGF0Zm9ybS53ZWJzZXJ2aWNlcy5uZXRzdWl0ZS5jb21cIjpcbiAgICAgIFwicGxhdGZvcm1fbWVzc2FnZXNcIixcbiAgfSxcbn07XG5cbi8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZW1wdHktaW50ZXJmYWNlXG5pbnRlcmZhY2Ugc29hcE9iamVjdCB7fVxuXG5pbnRlcmZhY2UgRWxlbWVudEluZm8ge1xuICB0eXBlSW5mbzogc3RyaW5nO1xuICBlbGVtZW50TmFtZTogc3RyaW5nO1xufVxuXG5mdW5jdGlvbiBlbGVtZW50S2V5Rm9yKG9iamVjdDogeyBjb25zdHJ1Y3RvcjogeyBuYW1lOiBzdHJpbmcgfSB9KSB7XG4gIGNvbnN0IGVsZW1lbnROYW1lID0gcGxhdGZvcm0uZWxlbWVudEluZm9zLmZpbmQoKGVsZW1lbnRJbmZvOiBFbGVtZW50SW5mbykgPT4ge1xuICAgIGNvbnN0IHR5cGVJbmZvID0gZWxlbWVudEluZm8udHlwZUluZm8uc3BsaXQoXCIuXCIpLnNsaWNlKC0xKVswXTtcbiAgICByZXR1cm4gdHlwZUluZm8gPT09IG9iamVjdC5jb25zdHJ1Y3Rvci5uYW1lO1xuICB9KT8uZWxlbWVudE5hbWU7XG4gIHJldHVybiBgcGxhdGZvcm1fbWVzc2FnZXM6JHtcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L3Jlc3RyaWN0LXRlbXBsYXRlLWV4cHJlc3Npb25zXG4gICAgZWxlbWVudE5hbWUgPz8gXCI8PFwiICsgb2JqZWN0LmNvbnN0cnVjdG9yLm5hbWUgKyBcIj4+XCJcbiAgfWA7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzZXJpYWxpemVTb2FwUmVxdWVzdChcbiAgcGFzc3BvcnQ6IFRva2VuUGFzc3BvcnQsXG4gIGJvZHk6IHNvYXBPYmplY3QsXG4gIHByZWZlcmVuY2VzPzogUHJlZmVyZW5jZXNQcm9wc1xuKTogc3RyaW5nIHtcbiAgY29uc3QgcGFzc3BvcnRFbGVtZW50ID0geyBuYW1lOiBlbGVtZW50S2V5Rm9yKHBhc3Nwb3J0KSwgdmFsdWU6IHBhc3Nwb3J0IH07XG4gIGNvbnN0IGhlYWRlckVsZW1lbnRzOiBhbnlbXSA9IFtwYXNzcG9ydEVsZW1lbnRdO1xuICBpZiAocHJlZmVyZW5jZXMpIHtcbiAgICBjb25zdCBwcmVmcyA9IG5ldyBQcmVmZXJlbmNlcyhwcmVmZXJlbmNlcyk7XG4gICAgaGVhZGVyRWxlbWVudHMucHVzaCh7XG4gICAgICBuYW1lOiBlbGVtZW50S2V5Rm9yKHByZWZzKSxcbiAgICAgIHZhbHVlOiBwcmVmcyxcbiAgICB9KTtcbiAgfVxuICBjb25zdCBib2R5RWxlbWVudCA9IHsgbmFtZTogZWxlbWVudEtleUZvcihib2R5KSwgdmFsdWU6IGJvZHkgfTtcbiAgY29uc3QgZW52ZWxvcGUgPSBuZXcgRW52ZWxvcGUoe1xuICAgIGhlYWRlcjogbmV3IEhlYWRlcih7IGFueTogaGVhZGVyRWxlbWVudHMgfSksXG4gICAgYm9keTogbmV3IEJvZHkoeyBhbnk6IFtib2R5RWxlbWVudF0gfSksXG4gIH0pO1xuICBjb25zdCBkYXRhID0geyBcInNvYXA6RW52ZWxvcGVcIjogZW52ZWxvcGUgfTtcbiAgY29uc3QgY29udGV4dCA9IG5ldyBKc29uaXguQ29udGV4dChBTExfTUFQUElOR1MsIEpTT05JWF9DT05URVhUX09QVElPTlMpO1xuICBjb25zdCB4bWxTdHJpbmcgPSBjb250ZXh0LmNyZWF0ZU1hcnNoYWxsZXIoKS5tYXJzaGFsU3RyaW5nKGRhdGEpO1xuXG4gIHJldHVybiAnPD94bWwgdmVyc2lvbj1cIjEuMFwiIGVuY29kaW5nPVwidXRmLThcIj8+JyArIHhtbFN0cmluZztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRlc2VyaWFsaXplU29hcFJlc3BvbnNlKHhtbENvbnRlbnQ6IHN0cmluZyk6IFhtbE9iamVjdCB7XG4gIGNvbnN0IGNvbnRleHQgPSBuZXcgSnNvbml4LkNvbnRleHQoQUxMX01BUFBJTkdTKTtcbiAgcmV0dXJuIGNvbnRleHQuY3JlYXRlVW5tYXJzaGFsbGVyPFhtbE9iamVjdD4oKS51bm1hcnNoYWxTdHJpbmcoeG1sQ29udGVudCk7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgWG1sT2JqZWN0IHtcbiAgdmFsdWU6IHtcbiAgICBib2R5OiB7XG4gICAgICBhbnk6IFt7IHZhbHVlOiB1bmtub3duIH1dO1xuICAgIH07XG4gIH07XG59XG5cbmZ1bmN0aW9uIGVuZHBvaW50KGNvbmZpZzogQ29uZmlndXJhdGlvbik6IHN0cmluZyB7XG4gIGNvbnN0IGFjY291bnQgPSBjb25maWcuYWNjb3VudC5yZXBsYWNlKFwiX1wiLCBcIi1cIik7XG4gIHJldHVybiBgaHR0cHM6Ly8ke2FjY291bnR9LnN1aXRldGFsay5hcGkubmV0c3VpdGUuY29tL3NlcnZpY2VzL05ldFN1aXRlUG9ydF8ke2NvbmZpZy5hcGlWZXJzaW9ufWA7XG59XG5cbi8qKlxuICogU2VyaWFsaXplcyB0aGUgcHJvdmlkZWQgcmVxdWVzdCBpbnRvIFhNTCBhbmQgc2VuZHMgYSBTT0FQIHJlcXVlc3QgdG8gdGhlIGNvbmZpZ3VyZWRcbiAqIGVuZHBvaW50LiBGb3Igc3VjY2Vzc2Z1bCByZXNwb25zZXMsIHJldHVybnMgdGhlIGRhdGEgZXh0cmFjdGVkIHRoZSBlbnZlbG9wZSBhbmQgY2FzdFxuICogaW50byB0aGUgdHlwZSBzcGVjaWZpZWQgYnkgdGhlIGdlbmVyaWMgdHlwZSBwYXJhbWV0ZXIgUi5cbiAqXG4gKiBJZiB0aGUgU09BUCByZXF1ZXN0IHJlc3VsdHMgaW4gYSBmYWlsZWQgcmVzcG9uc2UsIHJldHVybnMgdGhlIFNPQVAgRmF1bHQgd2l0aGluXG4gKiB0aGUgZW52ZWxvcGUgYXMgYSByZWplY3RlZCBwcm9taXNlLlxuICpcbiAqIEBwYXJhbSBjb25maWdcbiAqIEBwYXJhbSByZXF1ZXN0XG4gKiBAcGFyYW0gc29hcEFjdGlvblxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gc2VuZFNvYXBSZXF1ZXN0PFQsIFI+KFxuICBjb25maWc6IENvbmZpZ3VyYXRpb24sXG4gIHJlcXVlc3Q6IFQsXG4gIHNvYXBBY3Rpb246IHN0cmluZ1xuKTogUHJvbWlzZTxSPiB7XG4gIGNvbnN0IGF1dGhUb2tlbiA9IGF1dGhlbnRpY2F0ZVJlcXVlc3RXaXRoVG9rZW5QYXNzcG9ydChjb25maWcpO1xuICBjb25zdCBzb2FwWE1MID0gc2VyaWFsaXplU29hcFJlcXVlc3QoYXV0aFRva2VuLCByZXF1ZXN0LCBjb25maWcucHJlZmVyZW5jZXMpO1xuICB0cnkge1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgYXhpb3MucG9zdChlbmRwb2ludChjb25maWcpLCBzb2FwWE1MLCB7XG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgIFNPQVBBY3Rpb246IHNvYXBBY3Rpb24sXG4gICAgICAgIGNvbnRlbnRUeXBlOiBcInRleHQveG1sOyBjaGFyc2V0PVVURi04XCIsXG4gICAgICB9LFxuICAgICAgLy8gV2UgYXJlIHVzaW5nIHRoaXMgbGlicmFyeSBpbiBOb2RlLCB0aGlzIHdvcmtzIHdlbGwgZm9yIEplc3QgYW5kIFByb2R1Y3Rpb24uXG4gICAgICBhZGFwdGVyOiBodHRwQWRhcHRlcixcbiAgICB9KTtcbiAgICBjb25zdCBzb2FwRW52ZWxvcGUgPSBkZXNlcmlhbGl6ZVNvYXBSZXNwb25zZShyZXNwb25zZS5kYXRhKTtcbiAgICByZXR1cm4gc29hcEVudmVsb3BlLnZhbHVlLmJvZHkuYW55WzBdLnZhbHVlIGFzIFI7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgaWYgKGVycm9yLnJlc3BvbnNlKSB7XG4gICAgICAvLyBOb24gMjB4IHJlc3BvbnNlXG4gICAgICBjb25zdCBzb2FwRW52ZWxvcGUgPSBkZXNlcmlhbGl6ZVNvYXBSZXNwb25zZShlcnJvci5yZXNwb25zZS5kYXRhKTtcbiAgICAgIGNvbnN0IGZhdWx0ID0gc29hcEVudmVsb3BlLnZhbHVlLmJvZHkuYW55WzBdLnZhbHVlIGFzIEZhdWx0O1xuICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KGZhdWx0KTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gTmV0d29yayBlcnJvci5cbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBhdXRoZW50aWNhdGVSZXF1ZXN0V2l0aFRva2VuUGFzc3BvcnQoXG4gIGNvbmZpZzogQ29uZmlndXJhdGlvblxuKTogVG9rZW5QYXNzcG9ydCB7XG4gIGNvbnN0IG5vbmNlID0gcmFuZG9tQnl0ZXMoMTgpLnRvU3RyaW5nKFwiaGV4XCIpO1xuICBjb25zdCB0aW1lU3RhbXAgPSBNYXRoLnJvdW5kKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC8gMTAwMCk7XG4gIGNvbnN0IGJhc2VTdHJpbmcgPSBbXG4gICAgY29uZmlnLmFjY291bnQsXG4gICAgY29uZmlnLnRva2VuLmNvbnN1bWVyS2V5LFxuICAgIGNvbmZpZy50b2tlbi50b2tlbktleSxcbiAgICBub25jZSxcbiAgICB0aW1lU3RhbXAsXG4gIF0uam9pbihcIiZcIik7XG4gIGNvbnN0IGJhc2U2NGhhc2ggPSBjcmVhdGVIbWFjKFxuICAgIFwic2hhMjU2XCIsXG4gICAgYCR7Y29uZmlnLnRva2VuLmNvbnN1bWVyU2VjcmV0fSYke2NvbmZpZy50b2tlbi50b2tlblNlY3JldH1gXG4gIClcbiAgICAudXBkYXRlKGJhc2VTdHJpbmcpXG4gICAgLmRpZ2VzdChcImJhc2U2NFwiKTtcblxuICByZXR1cm4gbmV3IFRva2VuUGFzc3BvcnQoe1xuICAgIGFjY291bnQ6IGNvbmZpZy5hY2NvdW50LFxuICAgIGNvbnN1bWVyS2V5OiBjb25maWcudG9rZW4uY29uc3VtZXJLZXksXG4gICAgbm9uY2U6IG5vbmNlLFxuICAgIHRpbWVzdGFtcDogdGltZVN0YW1wLFxuICAgIHRva2VuOiBjb25maWcudG9rZW4udG9rZW5LZXksXG4gICAgc2lnbmF0dXJlOiB7XG4gICAgICBhbGdvcml0aG06IFwiSE1BQ19TSEEyNTZcIixcbiAgICAgIHZhbHVlOiBiYXNlNjRoYXNoLFxuICAgIH0sXG4gIH0pO1xufVxuIl19